{% extends 'base.html' %}
{% load i18n %}
{% load myfilter %}
{% block description %}{% if album %}{{ album }}{% endif %}, {% trans 'images, pictures, photos' %}. {% endblock %}
{% block keywords %}{% if album %}{{ album }}, {% endif %}{% trans 'images, pictures, photos' %}. {% endblock %}
{% block title %}
{% if album %}{{ album }}{% else %}{% trans 'Photogallery' %}{% endif %} - {% trans 'images, pictures, photos' %} - {% endblock %}
{% block pagestyle %}
table.cont { padding: 10px 2px; }
#viewtab { visibility: hidden; border-collapse: collapse; position: fixed; left: 0; top: 0; background-color: rgba(100,100,100,0.8);
    padding:0 margin: 0; width: 100%; height: 100%; font-size: 40pt; }
.albcont { padding: 10px; }
.photocont { max-width: 150px; }
.nav { fill: rgba(255,255,255,0.6); }
{% endblock %}
{% block myclass %}wrap{% endblock %}
{% block pageheader %}{# trans 'Photogallery' #}{% endblock %}
{% block content %}
<script src="/media/js/dbcartasvg.js"></script>
<script type="text/javascript">
{% if album %}
if(window.addEventListener) {
    window.addEventListener('load', function(){ vc(1); }, false);
} else {
   window.attachEvent('onload', function(){ vc(1); });
}
{% endif %}

function viewphoto(counter, photo_id, photo_title, photo_user_id){
	var vTab = document.getElementById('viewtab'),
    	vCont = document.getElementById('viewcont'),
     thumbPhoto = document.getElementById('thumb' + counter); 
	  // add img
	var vPhoto = new Image();
	vPhoto.src = thumbPhoto.src.substr(0, thumbPhoto.src.length-5);
	vPhoto.id = '__' + thumbPhoto.id;
	vPhoto.title = thumbPhoto.title;
	vPhoto.onload = function() {
		vTab.style.visibility = 'visible';
		document.body.style.overflow='hidden';
		if (!window.dw){
			dw = new dbCartaSvg({
				id:'viewcont',
				height: vCont.offsetHeight,
				bg: 'transparent',
				sbar: 0,
				sbarpos: 'left',
				sbarsize:2
			});
			  // map size
			var mapWidth = dw.root.getAttribute('width'),
	            mapHeight = dw.root.getAttribute('height');
    		  // close
		    dw.closelink = dw.append(dw.root, 'a', {});
		    var text = dw.append(dw.closelink, 'text', {
		    	class: 'nav',
		    	'font-size':'150%',
		    	x:mapWidth, y:0, dy:'0.8em', 
		    	'text-anchor': 'end'
		    });
		    text.appendChild(document.createTextNode('\u2715'));
	          // viewprev
		    dw.prevlink = dw.append(dw.root, 'a', {});
		    var text = dw.append(dw.prevlink, 'text', {
		    	class: 'nav',
		    	x:0, y:mapHeight/2, dy: '0.25em',
		    	'font-size':'500%',
		    	'text-anchor': 'start'
		    });
		    text.appendChild(document.createTextNode('\u2039'));
	          // viewnext
		    dw.nextlink = dw.append(dw.root, 'a', {});
		    var text = dw.append(dw.nextlink, 'text', {
		    	class: 'nav',
		    	x:mapWidth, y:mapHeight/2, dy:'0.25em',
		    	'font-size':'500%',
		    	'text-anchor': 'end'
		    });
		    text.appendChild(document.createTextNode('\u203A'));
	          // viewfull
	        dw.viewfull = dw.append(dw.root, 'a', {});
	        dw.viewfull.setAttributeNS('http://www.w3.org/1999/xlink', 'title', "{% trans 'Click to view full size' %}");
		    var text = dw.append(dw.viewfull, 'text', {
		    	class: 'nav',
		    	'font-size':'150%',
		    	x:mapWidth, y:mapHeight, dy:'-0.2em',
		    	'text-anchor': 'end'
		    });
		    text.appendChild(document.createTextNode('\u2750'));
		      // caption
		    dw.caption = dw.append(dw.root, 'text', {
		    	class: 'nav',
		    	x:mapWidth/2, y:mapHeight, dy:'-0.25em',
		    	'font-size': '50%',
		    	'text-anchor': 'middle'
		    });
			  // img
	 	    dw.img = dw.append('image', {});
		    if ('{{ request.user.id }}' == photo_user_id || '{{ request.user.is_superuser }}'=='True') {
			      // viewedit
			    dw.viewedit = dw.append(dw.root, 'a', {});
			    var text = dw.append(dw.viewedit, 'text', {
			    	class: 'nav',
			    	'font-size':'150%',
			    	x:0, y:0, dy:'0.8em', 
			    	'text-anchor': 'start'
			    });
			    text.appendChild(document.createTextNode('\u2710'));
			      // viewdel
			    dw.viewdel = dw.append(dw.root, 'a', {});
			    var text = dw.append(dw.viewdel, 'text', {
			    	class: 'nav',
			      'font-size':'150%',
			    	x:0, y:mapHeight, dy:'-0.2em',
			    	'text-anchor': 'start'
			    });
			    text.appendChild(document.createTextNode('\u2672'));
		    }
		}
	    dw.closelink.setAttributeNS('http://www.w3.org/1999/xlink', 'href', 'javascript:cl()');
	    dw.closelink.setAttributeNS('http://www.w3.org/1999/xlink', 'title', "{% trans 'Close' %}");
		dw.prevlink.setAttributeNS('http://www.w3.org/1999/xlink', 'href', 'javascript:vc(' + (-(Number(this.id.substr(7))-1)) + ')');
		dw.nextlink.setAttributeNS('http://www.w3.org/1999/xlink', 'href', 'javascript:vc(' + (Number(this.id.substr(7))+1) + ')');
		dw.viewfull.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '/photos/orig/' + photo_id);
		if(dw.viewedit) dw.viewedit.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '/photos/edit/' + photo_id);
		if(dw.viewdel) dw.viewdel.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '/photos/del/' + photo_id);
		for(var i=0; i<dw.caption.childNodes.length; i++){ dw.caption.removeChild(dw.caption.childNodes[i]); }
		dw.caption.appendChild(document.createTextNode(this.title));
		var ratio = dw.root.getAttribute('width')/dw.root.getAttribute('height'),
		    vs = dw.viewsizeOf();  // map sizes
		var crds = [[-vs[1]*ratio,vs[1]],[-vs[3]*ratio,vs[3]]],
			  pts = [dw.toPoints(crds[1]), dw.toPoints(crds[0])];
		dw.img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', this.src+'=s800');
		dw.attr(dw.img, {
			width:  pts[0][0]-pts[1][0],
			height: pts[0][1]-pts[1][1],
			x: pts[1][0],
			y: pts[1][1],
			title: photo_title,
			cursor: 'pointer'
		});
	}
}
function cl(){ 
    document.getElementById("viewtab").style.visibility="hidden";
    document.body.style.overflow='auto';
}
function vc(counter) {
    var nref = document.getElementById('thumbref' + String(Math.abs(counter)));
    if (nref) {
    	eval(nref.href.replace('javascript:',''));
    } else if (counter<=0 && {% if photos.has_previous %}1{% else %}0{% endif %}){
    	var nref = document.getElementById('pageprev');
    	if (nref) location.href = nref.href;    	
    } else if (counter>0 && {% if photos.has_next %}1{% else %}0{% endif %}){
    	var nref = document.getElementById('pagenext');
    	if (nref) location.href = nref.href;    	
    } else {
    	var nref = document.getElementById('thumbref1');
    	if (nref) eval(nref.href.replace('javascript:',''));
    };
}
</script>
<p>Подборка фотографий, снятых на телефон, о природе, местах, людях. Смотрите, добавляйте свои работы.</p>
{% if photos_count %}
  {% if album %}
    <p>Найдено <b>{{ photos_count }}</b> изображений в альбоме <b>{{ album }}</b>.</p>
  {% else %}
    <p>Найдено <b>{{ photos_count }}</b> альбомов.</p>
  {% endif %}
{% endif %}

{% if photos.object_list %}
  <div class="wrap">
    <table class="cont">
  {% for photo in photos.object_list %}
    {% if forloop.counter in rows_count %}<tr>{% endif %}
    {% if photos.has_previous %}
      <td>{% if forloop.counter == 1 %}
        <a id="pageprev" class="nodecor" href="{% if album %}{% url 'my.views.list_photos' id_album=photo.id %}{% else %}{% url 'my.views.list_photos' %}{% endif %}?page={{ photos.previous_page_number }}">
          <img src='{{ MEDIA_URL }}img/s_prev.png' title="{% trans 'previous' %}" alt="{% trans 'previous' %}" /></a>
      {% endif %}</td>
    {% endif %}
      {% if album %}
        <td class="photocont" align="center">
          <a id="thumbref{{ forloop.counter }}" class="nodecor" href="javascript:viewphoto({{ forloop.counter }},{{ photo.id }},'{{ photo.title }}','{{ photo.author.id }}');">
            <img id="thumb{{ forloop.counter }}" src="{% if not photo.memberonly or request.user.is_superuser %}{{ photo.thumb_url }}=s128{% endif %}" title="{{ photo.title }}" alt="{{ photo.title }}"/><br/>
            <span class="gray smaller">{{ photo.title }}</span></a>
        </td>
      {% else %}
        <td class="albcont" align="center">
          <a class="nodecor" href="{% url 'my.views.list_photos' id_album=photo.id %}">
            <img id="thumb{{ forloop.counter }}" src="{% if not photo.memberonly or request.user.is_superuser %}{{ photo.thumb_url }}{% endif %}=s400" title="{{ photo.title }}" alt="{{ photo.title }}"/><br/>
          {{ photo.album }}</a><span class="smaller"> [{{ photo.album_count }}]</span><br/>
            <span class="gray smaller">{{ photo.date|time_since }}</span>
        </td>
      {% endif %}        
    {% if photos.has_next %}
      <td>{% if forloop.revcounter == 1 %}
        <a id="pagenext" class="nodecor" href="{% if album %}{% url 'my.views.list_photos' id_album=photo.id %}{% else %}{% url 'my.views.list_photos' %}{% endif %}?page={{ photos.next_page_number }}">
          <img src='{{ MEDIA_URL }}img/s_next.png' title="{% trans 'next' %}" alt="{% trans 'next' %}" /></a>
      {% endif %}</td>
    {% endif %}
  {% endfor %}
    </table>
  </div>
{% else %}

  <p>{% trans 'No photos' %}.</p>

{% endif %}
{% if request.user.is_authenticated %}
  <p class="smaller hspace"><a href="{% url 'my.views.add_photo' %}">{% trans 'Add photo' %}</a></p>
{% else %}
  <p class="smaller hspace">{% trans 'Please authorize to upload photos' %}.</p>
{% endif %}
<!-- viewphoto -->
<table id="viewtab">
<tr>
<td id="viewcont"></td>
</tr>
</table>
<!-- /viewphoto -->
{% endblock %}
