{% extends 'base.html' %}
{% load i18n %}
{% load myfilter %}
{% block description %}{% if book_count %}. {% with books.object_list|first as f %}{{ f.writer.writer }}{% endwith %}{% endif %}, {% trans 'books' %}{% endblock %}
{% block keywords %}{% if book_count %}, {% with books.object_list|first as f %}{{ f.writer.writer }}{% endwith %}{% endif %}, {% trans 'books' %}{% endblock %}
{% block title %}
{% if search_count %}{% trans 'Search result' %}{% endif %}
{% if book_count and not search_count %}{% if subject %}Жанр {{ subject.subject }}{% else %}{% if wrt_key %}Список авторов{% else %}{% with books.object_list|first as f %}{{ f.writer.writer }}{% endwith %}{% endif %}{% endif %}{% endif %}
{% if not book_count and not search_count %}{% trans 'Books' %}{% endif %}
 - {% trans 'books' %} - {% endblock %}
{% block pagestyle %}
table.cont { width: 100%; border-collapse: collapse; }
table.cont td.cont { text-align: left; vertical-align: top; }
table.cont td.prev { text-align: left; width: 32px; }
table.cont td.next { text-align: right; width: 32px; }
table.cont td.cover { text-align: center; width: 140px; }
.lside { width:30%; }
.cside { width: 1%; }
.rside { width:69%; }
.lside2 { min-width:20%; max-width:200px; }
.rside2 { min-width:70%; max-width: 200px; overflow: hidden; }
.msgtext dt.cont { border:0; padding:0; }
dt .cont { display: table; width: 100%; }
.bbar .button { padding: 20px 40px; margin: 10px 20px; border: 1px solid transparent; }
.bbar .button:hover { border: 1px dashed lightgray; }
#id_search { height: 16px; margin-left: 12px; }
{% endblock %}
{% block booksclass %}wrap{% endblock %}
{% block pageheader %}
{% endblock %}
{% block content %}

<div class="indexlist wrap">
  <a class="hspaced" href="{% url 'books.views.list_wrt' %}">{% trans 'Full list' %}</a>
  {% for i, v in wrt_index.items %}
    <a class="nodecor hspaced" href="{% url 'books.views.list_wrt' ind_wrt=i %}">{{ v|capfirst }}</a>
  {% endfor %}
  <form class="search" action="{% url 'books.views.list_books' %}" method="get">{% csrf_token %}
    {{ form }}
    <input class="submit" type="submit" value="{% trans 'Search' %}" />
  </form>
</div>

{% if not book_count and not search_count %}
<p>
Коллекция электронных книг различных жанров отечественных и зарубежных авторов. 
Все тексты взяты из свободных источников и представлены исключительно для ознакомления.
</p>
{% endif %}

<p>
{% if book_count and not search_count %}
  {% if subject %}<span class="hspace">Жанр <b>{{ subject.subject }}</b></span>{% endif %}
  {% if writer %}
    <h2 class="inl nomarg"><a class="nodecor" href="{% url 'books.views.list_books' id_wrt=writer.id %}">
      <span class="hspace">{{ writer.writer }}</span></a></h2>
  {% endif %}
{% endif %}
{% if book_count or wrt_count %}
  <span class="hspace"></span> Найдено {% if wrt_count %}<b>{{ wrt_count }}</b> писателей{% endif %}{% if book_count %}<b> {{ book_count }}</b> книг{% endif %}
{% endif %}
</p>

{% if books.object_list %}

{% if book_count and not wrt_count %}

  {% if books.has_previous %}
    {% if search_count %}
      <a href="?{% if request.GET.search %}search={{ request.GET.search|urlencode }}&{% endif %}page={{ books.previous_page_number }}">
    {% endif %}
    {% if not search_count %}
      <a href="{% if subject %}{% url 'books.views.list_books' id_subj=subject.id %}{% else %}{% url 'books.views.list_books' id_wrt=writer.id %}{% endif %}?page={{ books.previous_page_number }}">    
    {% endif %}
      <div class="wrap cfloat">
        <img src='{{ MEDIA_URL }}img/s_up.png' title="{% trans 'previous' %}" alt="{% trans 'previous' %}" /></div></a>
  {% endif %}

  {% for book in books.object_list %}
    <div class="wrap">
    <dl class="msgtext"><dt class="cont">
      <div class="cont">
  	  <div class="lfloat lside2 cfloat">
  	    <a id="thumbref{{ forloop.counter }}" class="nodecor" href="{% url 'books.views.read_book' ind=book.index part=book.part %}">
  	    {% if subject or search_count %}
  	      <div class="gray smaller">{{ book.writer.writer }}</div></a>
  	    {% endif %}
  	      <img id="thumb{{ forloop.counter }}" title="{{ book.writer.writer }} {{ book.title }}" alt="{{ book.writer.writer }} {{ book.title }}" src="{% url 'books.views.read_book' ind=book.index part='cover.jpeg' %}" width="160px"/><br/>
  	      <div class="gray smaller">{{ book.title }}</div></a>
	    </div>
	    <div class="lfloat rside2 smaller">
	      <br/>{{ book.content }}
      </div>
      <div class="bbar smaller">
        <a class="nodecor" href="{% url 'books.views.get_file' ind=book.index %}"><div class="pink button lfloat">Скачать</div></a>&nbsp;
        <a class="nodecor" href="{% url 'books.views.read_book' ind=book.index part=book.part %}"><div class="pink button lfloat">Читать</div></a>
      </div>
	    </div>
    </dt></dl>
    </div>
  {% endfor %}

  {% if books.has_next %}
    {% if not search_count %}
      <a id="pagenext" class="nodecor" href="{% if subject %}{% url 'books.views.list_books' id_subj=subject.id %}{% else %}{% url 'books.views.list_books' id_wrt=writer.id %}{% endif %}?page={{ books.next_page_number }}">      
    {% endif %}
      <div class="wrap cfloat">
        <img src='{{ MEDIA_URL }}img/s_down.png' title="{% trans 'next' %}" alt="{% trans 'next' %}" /></div></a>
  {% endif %}

  {% if search_count >= books.per_page %}
    {% if search_count %}
      <a href="?{% if request.GET.search %}search={{ request.GET.search|urlencode }}&{% endif %}page={{ books.next_page_number }}">
      <div class="wrap cfloat">
        <img src='{{ MEDIA_URL }}img/s_down.png' title="{% trans 'next' %}" alt="{% trans 'next' %}" /></div></a>
    {% endif %}
  {% endif %}

  {% if books.paginator.num_pages > 1 %}
    <p class="cfloat smaller">
      {% trans 'Page' %} {{ books.number }} {% trans 'of' %} {{ books.paginator.num_pages }}
    </p>
  {% endif %}

{% else %}

  {% if subjects.object_list %}
    <div class="lfloat lside">
      <div class="wrap wrap_header wrapbg">Жанры</div>
    <div class="wrap">
  {% for subj in subjects.object_list %}
    <dl class="msgtext">
      <dt><a class="nodecor" href="{% url 'books.views.list_books' id_subj=subj.id %}">{{ subj.subject }}</a>
        <span class="smaller">[{{ subj.count }}]</span></dt>
    </dl>
  {% endfor %}
    </div>
    </div>
    <div class="lfloat cside">&nbsp;</div>
  {% endif %}
  
  {% if last_count %}
    <div class="lfloat rside">
      <div class="wrap wrap_header wrapbg">Последние добавления</div>
  {% endif %}
  
  {% if last_count %}
    {% if books.has_previous %}
      <a href="?page={{ books.previous_page_number }}">
        <div class="wrap cfloat">
          <img src='{{ MEDIA_URL }}img/s_up.png' title="{% trans 'previous' %}" alt="{% trans 'previous' %}" /></div></a>
    {% endif %}
  {% endif %}

  {% if wrt_count %}
    {% if books.has_previous %}
      <a href="?{% if request.GET.search %}search={{ request.GET.search|urlencode }}&{% endif %}page={{ books.previous_page_number }}">
        <div class="wrap cfloat">
          <img src='{{ MEDIA_URL }}img/s_up.png' title="{% trans 'previous' %}" alt="{% trans 'previous' %}" /></div></a>
    {% endif %}
  {% endif %}

    <div class="wrap">
  {% for book in books.object_list %}
    <dl class="msgtext"><dt>
    {% if wrt_count %}
      <a class="nodecor" href="{% url 'books.views.list_books' id_wrt=book.id %}">{{ book.writer.writer }}</a>
    {% endif %}
    {% if book.count %}
      <span class="smaller">[{{ book.count }}]</span>
    {% endif %}
    {% if last_count or search_count%}
      <div class="cont">
      <div class="lfloat lside2 cfloat">
        <a id="thumbref{{ forloop.counter }}" class="nodecor" href="{% url 'books.views.read_book' ind=book.index part=book.part %}">
          <img id="thumb{{ forloop.counter }}" src="{% url 'books.views.read_book' ind=book.index part='cover.jpeg' %}" title="{{ book.title }}" alt="{{ book.title }}" width="100px"/></a>
      </div>
      <div class="lfloat rside2">
        <br/><a class="nodecor" href="{% url 'books.views.list_books' id_wrt=book.writer.id %}">{{ book.writer.writer }}</a>
          <a href="{% url 'books.views.read_book' ind=book.index part=book.part %}">{{ book.title|escape }}</a>
      </div>
      <div class="bbar smaller">
        <a class="nodecor" href="{% url 'books.views.get_file' ind=book.index %}"><div class="pink button lfloat">Скачать</div></a>&nbsp;
        <a class="nodecor" href="{% url 'books.views.read_book' ind=book.index part=book.part %}"><div class="pink button lfloat">Читать</div></a>
      </div>
      </div>
    {% endif %}
    </dt>
    {% if last_count %}
      <dd class="smaller">{{ book.date|time_since }} {% trans 'ago' %}</dd>
    {% endif %}
    </dl>
  {% endfor %}
    </div>
    
  {% if last_count %}
    <a href="?page={{ books.next_page_number }}"><div class="wrap cfloat">
      <img src='{{ MEDIA_URL }}img/s_down.png' title="{% trans 'next' %}" alt="{% trans 'next' %}" /></div></a>
  {% endif %}
    </div>

  {% if wrt_count %}
    {% if books.has_next %}
      <a href="?{% if request.GET.search %}search={{ request.GET.search|urlencode }}&{% endif %}page={{ books.next_page_number }}">
        <div class="wrap cfloat">
          <img src='{{ MEDIA_URL }}img/s_down.png' title="{% trans 'next' %}" alt="{% trans 'next' %}" /></div></a>
    {% endif %}
  {% endif %}

{% endif %}

{% else %}

  <p>{% trans 'No books' %}.</p>

{% endif %}

{% if request.user.is_authenticated %}
  <p class="smaller hspace"><a href="{% url 'books.views.add_book' %}">{% trans 'Add book' %}</a></p>
{% else %}
  <p class="smaller hspace">{% trans 'Please authorize to add books' %}.</p>
{% endif %}

{% endblock %}
